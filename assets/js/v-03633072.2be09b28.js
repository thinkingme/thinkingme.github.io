"use strict";(self.webpackChunkcoding_road=self.webpackChunkcoding_road||[]).push([[4802],{84426:(n,a,s)=>{s.r(a),s.d(a,{data:()=>e});const e={key:"v-03633072",path:"/coding-road/javaee/wheels/log4j2.html",title:"Log4j 2：Apache 维护的一款高性能日志记录工具",lang:"zh-CN",frontmatter:{category:["Java企业级开发"],tag:["辅助工具/轮子"],summary:"Log4j 2：Apache 维护的一款高性能日志记录工具 Log4j 介绍过了，SLF4J 介绍过了，Logback 也介绍过了，你以为日志系列的文章就到此终结了？ 不不不，我告诉你，还有一个 Log4j 2，顾名思义，它就是 Log4j 的升级版，就好像手机里面的 Pro 版。我作为一个写文章方面的工具人，或者叫打工人，怎么能不写完这最后一篇。 Log4",head:[["meta",{property:"og:url",content:"https://vuepress-theme-hope-v2-demo.mrhope.site/coding-road/javaee/wheels/log4j2.html"}],["meta",{property:"og:site_name",content:"coding-rode"}],["meta",{property:"og:title",content:"Log4j 2：Apache 维护的一款高性能日志记录工具"}],["meta",{property:"og:type",content:"article"}],["meta",{property:"og:updated_time",content:"2022-06-04T07:20:53.000Z"}],["meta",{property:"og:locale",content:"zh-CN"}],["meta",{property:"article:tag",content:"辅助工具/轮子"}],["meta",{property:"article:modified_time",content:"2022-06-04T07:20:53.000Z"}]]},excerpt:"",headers:[{level:3,title:"01、Log4j 2 强在哪",slug:"_01、log4j-2-强在哪",children:[]},{level:3,title:"02、Log4j 2 使用示例",slug:"_02、log4j-2-使用示例",children:[]},{level:3,title:"03、Async 示例",slug:"_03、async-示例",children:[]},{level:3,title:"04、RollingFile 示例",slug:"_04、rollingfile-示例",children:[]}],git:{createdTime:1653617096e3,updatedTime:1654327253e3,contributors:[{name:"林振辉",email:"linzhenhui@apexsoft.com",commits:2}]},readingTime:{minutes:9.14,words:2742},filePathRelative:"coding-road/javaee/wheels/log4j2.md"}},62283:(n,a,s)=>{s.r(a),s.d(a,{default:()=>k});var e=s(95393);const t=(0,e._)("h1",{id:"log4j-2-apache-维护的一款高性能日志记录工具",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#log4j-2-apache-维护的一款高性能日志记录工具","aria-hidden":"true"},"#"),(0,e.Uk)(" Log4j 2：Apache 维护的一款高性能日志记录工具")],-1),l={href:"https://mp.weixin.qq.com/s/AXgNnJe8djD901EmhFkWUg",target:"_blank",rel:"noopener noreferrer"},o=(0,e.Uk)("Log4j"),i=(0,e.Uk)(" 介绍过了，"),p={href:"https://mp.weixin.qq.com/s/EhKf1rHWL-QII0f6eo0uVA",target:"_blank",rel:"noopener noreferrer"},c=(0,e.Uk)("SLF4J"),g=(0,e.Uk)(" 介绍过了，"),r={href:"https://mp.weixin.qq.com/s/mm0OYM-raVBi2KwK_QK21g",target:"_blank",rel:"noopener noreferrer"},u=(0,e.Uk)("Logback"),d=(0,e.Uk)(" 也介绍过了，你以为日志系列的文章就到此终结了？"),v=(0,e.uE)('<p>不不不，我告诉你，还有一个 Log4j 2，顾名思义，它就是 Log4j 的升级版，就好像手机里面的 Pro 版。我作为一个写文章方面的工具人，或者叫打工人，怎么能不写完这最后一篇。</p><p>Log4j、SLF4J、Logback 是一个爹——Ceki Gulcu，但 Log4j 2 却是例外，它是 Apache 基金会的产品。</p><p>SLF4J 和 Logback 作为 Log4j 的替代品，在很多方面都做了必要的改进，那为什么还需要 Log4j 2 呢？我只能说 Apache 基金会的开发人员很闲，不，很拼，要不是他们这种精益求精的精神，这个编程的世界该有多枯燥，毕竟少了很多可以用“拿来就用”的轮子啊。</p><p>上一篇也说了，老板下死命令要我把日志系统切换到 Logback，我顺利交差了，老板很开心，夸我这个打工人很敬业。为了表达对老板的这份感谢，我决定偷偷摸摸地试水一下 Log4j 2，尽管它还不是个成品，可能会会项目带来一定的隐患。但谁让咱是一个敬岗爱业的打工人呢。</p><p><img src="http://cdn.tobebetterjavaer.com/tobebetterjavaer/images/gongju/log4j2-a9461265-7652-4512-9219-6b3e82392415.png" alt="" loading="lazy"></p><h3 id="_01、log4j-2-强在哪" tabindex="-1"><a class="header-anchor" href="#_01、log4j-2-强在哪" aria-hidden="true">#</a> 01、Log4j 2 强在哪</h3><p>1）在多线程场景下，Log4j 2 的吞吐量比 Logback 高出了 10 倍，延迟降低了几个数量级。这话听起来像吹牛，反正是 Log4j 2 官方自己吹的。</p><p>Log4j 2 的异步 Logger 使用的是无锁数据结构，而 Logback 和 Log4j 的异步 Logger 使用的是 ArrayBlockingQueue。对于阻塞队列，多线程应用程序在尝试使日志事件入队时通常会遇到锁争用。</p><p>下图说明了多线程方案中无锁数据结构对吞吐量的影响。 Log4j 2 随着线程数量的扩展而更好地扩展：具有更多线程的应用程序可以记录更多的日志。其他日志记录库由于存在锁竞争的关系，在记录更多线程时，总吞吐量保持恒定或下降。这意味着使用其他日志记录库，每个单独的线程将能够减少日志记录。</p><p><img src="http://cdn.tobebetterjavaer.com/tobebetterjavaer/images/gongju/log4j2-43f0b03d-5c4a-4af3-9e4c-177956246740.png" alt="" loading="lazy"></p><p>性能方面是 Log4j 2 的最大亮点，至于其他方面的一些优势，比如说下面这些，可以忽略不计，文字有多短就代表它有多不重要。</p><p>2）Log4j 2 可以减少垃圾收集器的压力。</p><p>3）支持 Lambda 表达式。</p><p>4）支持自动重载配置。</p><h3 id="_02、log4j-2-使用示例" tabindex="-1"><a class="header-anchor" href="#_02、log4j-2-使用示例" aria-hidden="true">#</a> 02、Log4j 2 使用示例</h3><p>废话不多说，直接实操开干。理论知识有用，但不如上手实操一把，这也是我多年养成的一个“不那么良好”的编程习惯：在实操中发现问题，解决问题，寻找理论基础。</p><p><strong>第一步</strong>，在 pom.xml 文件中添加 Log4j 2 的依赖：</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.logging.log4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>log4j-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.logging.log4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>log4j-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（这个 artifactId 还是 log4j，没有体现出来 2，而在 version 中体现，多少叫人误以为是 log4j）</p><p><strong>第二步</strong>，来个最简单的测试用例：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span></span><span class="token class-name">LogManager</span></span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span>\n    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LogManager</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">Demo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;log4j2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行 Demo 类，可以在控制台看到以下信息：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>ERROR StatusLogger No log4j2 configuration file found. Using default configuration: logging only errors to the console.\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>Log4j 2 竟然没有在控制台打印“ log4j2”，还抱怨我们没有为它指定配置文件。在这一点上，我就觉得它没有 Logback 好，毕竟人家会输出。</p><p>这对于新手来说，很不友好，因为新手在遇到这种情况的时候，往往不知所措。日志里面虽然体现了 ERROR，但代码并没有编译出错或者运行出错，凭什么你不输出？</p><p>那作为编程老鸟来说，我得告诉你，这时候最好探究一下为什么。怎么做呢？</p><p>我们可以复制一下日志信息中的关键字，比如说：“No log4j2 configuration file found”，然后在 Intellij IDEA 中搜一下，如果你下载了源码和文档的话，不除意外，你会在 ConfigurationFactory 类中搜到这段话。</p><p>可以在方法中打个断点，然后 debug 一下，你就会看到下图中的内容。</p><p><img src="http://cdn.tobebetterjavaer.com/tobebetterjavaer/images/gongju/log4j2-4ba440d9-c0b6-4ad2-b538-9d303cc99d90.png" alt="" loading="lazy"></p><p>通过源码，你可以看得到，Log4j 2 会去寻找 4 种类型的配置文件，后缀分别是 properties、yaml、json 和 xml。前缀是 log4j2-test 或者 log4j2。</p><p>得到这个提示后，就可以进行第三步了。</p><p>**第三步，**在 resource 目录下增加 log4j2-test.xml 文件（方便和 Logback 做对比），内容如下所示：</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Configuration</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Appenders</span><span class="token punctuation">&gt;</span></span>\n        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Console</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Console<span class="token punctuation">&quot;</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>SYSTEM_OUT<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\n            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PatternLayout</span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>\n        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Console</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Appenders</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Loggers</span><span class="token punctuation">&gt;</span></span>\n        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Root</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>DEBUG<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\n            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AppenderRef</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Console<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>\n        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Root</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Loggers</span><span class="token punctuation">&gt;</span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Configuration</span><span class="token punctuation">&gt;</span></span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Log4j 2 的配置文件格式和 Logback 有点相似，基本的结构为 <code>&lt; Configuration&gt;</code> 元素，包含 0 或多个 <code>&lt; Appenders&gt;</code> 元素，其后跟 0 或多个 <code>&lt; Loggers&gt;</code> 元素，里面再跟最多只能存在一个的 <code>&lt; Root&gt;</code> 元素。</p><p><strong>1）配置 appender</strong>，也就是配置日志的输出目的地。</p><p>有 Console，典型的控制台配置信息上面你也看到了，我来简单解释一下里面 pattern 的格式：</p><ul><li><p><code>%d{HH:mm:ss.SSS}</code> 表示输出到毫秒的时间</p></li><li><p><code>%t</code> 输出当前线程名称</p></li><li><p><code>%-5level</code> 输出日志级别，-5 表示左对齐并且固定输出 5 个字符，如果不足在右边补空格</p></li><li><p><code>%logger</code> 输出 logger 名称，最多 36 个字符</p></li><li><p><code>%msg</code> 日志文本</p></li><li><p><code>%n</code> 换行</p></li></ul><p>顺带补充一下其他常用的占位符：</p><ul><li><p><code>%F</code> 输出所在的类文件名，如 Demo.java</p></li><li><p><code>%L</code> 输出行号</p></li><li><p><code>%M</code> 输出所在方法名</p></li><li><p><code>%l</code> 输出语句所在的行数, 包括类名、方法名、文件名、行数</p></li><li><p><code>%p</code> 输出日志级别</p></li><li><p><code>%c</code> 输出包名，如果后面跟有 <code>{length.}</code> 参数，比如说 <code>%c{1.}</code>，它将输出报名的第一个字符，如 <code>com.itwanger</code> 的实际报名将只输出 <code>c.i</code></p></li></ul><p>再次运行 Demo 类，就可以在控制台看到打印的日志信息了：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>10:14:04.657 [main] DEBUG com.itwanger.Demo - log4j2\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>2）配置 Loggers</strong>，指定 Root 的日志级别，并且指定具体启用哪一个 Appenders。</p><p><strong>3）自动重载配置</strong>。</p><p>Logback 支持自动重载配置，Log4j 2 也支持，那想要启用这个功能也非常简单，只需要在 Configuration 元素上添加 <code>monitorInterval</code> 属性即可。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>&lt;Configuration monitorInterval=&quot;30&quot;&gt;\n...\n&lt;/Configuration&gt;\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意值要设置成非零，上例中的意思是至少 30 秒后检查配置文件中的更改。最小间隔为 5 秒。</p><h3 id="_03、async-示例" tabindex="-1"><a class="header-anchor" href="#_03、async-示例" aria-hidden="true">#</a> 03、Async 示例</h3><p>除了 Console，还有 Async，可以配合文件的方式来异步写入，典型的配置信息如下所示：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>&lt;Configuration&gt;\n  &lt;Appenders&gt;\n    &lt;File name=&quot;DebugFile&quot; fileName=&quot;debug.log&quot;&gt;\n      &lt;PatternLayout&gt;\n        &lt;Pattern&gt;%d %p %c [%t] %m%n&lt;/Pattern&gt;\n      &lt;/PatternLayout&gt;\n    &lt;/File&gt;\n    &lt;Async name=&quot;Async&quot;&gt;\n      &lt;AppenderRef ref=&quot;DebugFile&quot;/&gt;\n    &lt;/Async&gt;\n  &lt;/Appenders&gt;\n  &lt;Loggers&gt;\n    &lt;Root level=&quot;debug&quot;&gt;\n      &lt;AppenderRef ref=&quot;Async&quot;/&gt;\n    &lt;/Root&gt;\n  &lt;/Loggers&gt;\n&lt;/Configuration&gt;\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对比 Logback 的配置文件来看，Log4j 2 真的复杂了一些，不太好用，就这么直白地说吧！但自己约的，含着泪也得打完啊。把这个 Async 加入到 Appenders：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>&lt;Configuration&gt;\n    &lt;Appenders&gt;\n        &lt;Console name=&quot;Console&quot; target=&quot;SYSTEM_OUT&quot;&gt;\n            &lt;PatternLayout pattern=&quot;%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n&quot;/&gt;\n        &lt;/Console&gt;\n        &lt;File name=&quot;DebugFile&quot; fileName=&quot;debug.log&quot;&gt;\n            &lt;PatternLayout&gt;\n                &lt;Pattern&gt;%d %p %c [%t] %m%n&lt;/Pattern&gt;\n            &lt;/PatternLayout&gt;\n        &lt;/File&gt;\n        &lt;Async name=&quot;Async&quot;&gt;\n            &lt;AppenderRef ref=&quot;DebugFile&quot;/&gt;\n        &lt;/Async&gt;\n    &lt;/Appenders&gt;\n    &lt;Loggers&gt;\n        &lt;Root level=&quot;DEBUG&quot;&gt;\n            &lt;AppenderRef ref=&quot;Console&quot;/&gt;\n            &lt;AppenderRef ref=&quot;Async&quot;/&gt;\n        &lt;/Root&gt;\n    &lt;/Loggers&gt;\n&lt;/Configuration&gt;\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再次运行 Demo 类，可以在项目根路径下看到一个 debug.log 文件，内容如下所示：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>2020-10-30 09:35:49,705 DEBUG com.itwanger.Demo [main] log4j2\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_04、rollingfile-示例" tabindex="-1"><a class="header-anchor" href="#_04、rollingfile-示例" aria-hidden="true">#</a> 04、RollingFile 示例</h3><p>当然了，Log4j 和 Logback 我们都配置了 RollingFile，Log4j 2 也少不了。RollingFile 会根据 Triggering（触发）策略和 Rollover（过渡）策略来进行日志文件滚动。如果没有配置 Rollover，则使用 DefaultRolloverStrategy 来作为 RollingFile 的默认配置。</p><p>触发策略包含有，基于 cron 表达式（源于希腊语，时间的意思，用来配置定期执行任务的时间格式）的 CronTriggeringPolicy；基于文件大小的 SizeBasedTriggeringPolicy；基于时间的 TimeBasedTriggeringPolicy。</p><p>过渡策略包含有，默认的过渡策略 DefaultRolloverStrategy，直接写入的 DirectWriteRolloverStrategy。一般情况下，采用默认的过渡策略即可，它已经足够强大。</p><p>来看第一个基于 SizeBasedTriggeringPolicy 和 TimeBasedTriggeringPolicy 策略，以及缺省 DefaultRolloverStrategy 策略的配置示例：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>&lt;Configuration&gt;\n  &lt;Appenders&gt;\n    &lt;RollingFile name=&quot;RollingFile&quot; fileName=&quot;rolling.log&quot;\n                 filePattern=&quot;rolling-%d{yyyy-MM-dd}-%i.log&quot;&gt;\n      &lt;PatternLayout&gt;\n        &lt;Pattern&gt;%d %p %c{1.} [%t] %m%n&lt;/Pattern&gt;\n      &lt;/PatternLayout&gt;\n      &lt;Policies&gt;\n        &lt;SizeBasedTriggeringPolicy size=&quot;1 KB&quot;/&gt;\n      &lt;/Policies&gt;\n    &lt;/RollingFile&gt;\n  &lt;/Appenders&gt;\n  &lt;Loggers&gt;\n    &lt;Root level=&quot;debug&quot;&gt;\n      &lt;AppenderRef ref=&quot;RollingFile&quot;/&gt;\n    &lt;/Root&gt;\n  &lt;/Loggers&gt;\n&lt;/Configuration&gt;\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为了验证文件的滚动策略，我们调整一下 Demo 类，让它多打印点日志：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>for (int i = 1;i &lt; 20; i++) {\n    logger.debug(&quot;微信搜索「{}」，回复关键字「{}」，有惊喜哦&quot;,&quot;沉默王二&quot;, &quot;java&quot;);\n}\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再次运行 Demo 类，可以看到根目录下多了 3 个日志文件：</p><p><img src="http://cdn.tobebetterjavaer.com/tobebetterjavaer/images/gongju/log4j2-07af98ca-cf94-427e-adb6-bd935e32a8d0.png" alt="" loading="lazy"></p><p>结合日志文件名，再来看 RollingFile 的配置，就很容易理解了。</p><p>1）fileName 用来指定文件名。</p><p>2）filePattern 用来指定文件名的模式，它取决于过渡策略。</p><p>由于配置文件中没有显式指定过渡策略，因此 RollingFile 会启用默认的 DefaultRolloverStrategy。</p><p>先来看一下 DefaultRolloverStrategy 的属性：</p><p><img src="http://cdn.tobebetterjavaer.com/tobebetterjavaer/images/gongju/log4j2-32b853ce-8beb-496b-b66f-31b650c257ab.png" alt="" loading="lazy"></p><p>再来看 filePattern 的值 <code>rolling-%d{yyyy-MM-dd}-%i.log</code>，其中 <code>%d{yyyy-MM-dd}</code> 很好理解，就是年月日；其中 <code>%i</code> 是什么意思呢？</p><p>第一个日志文件名为 rolling.log（最近的日志放在这个里面），第二个文件名除去日期为 rolling-1.log，第二个文件名除去日期为 rolling-2.log，根据这些信息，你能猜到其中的规律吗？</p><p>其实和 DefaultRolloverStrategy 中的 max 属性有关，目前使用的默认值，也就是 7，那就当 rolling-8.log 要生成的时候，删除 rolling-1.log。可以调整 Demo 中的日志输出量来进行验证。</p><p>3）SizeBasedTriggeringPolicy，基于日志文件大小的时间策略，大小以字节为单位，后缀可以是 KB，MB 或 GB，例如 20 MB。</p><p>再来看一个日志文件压缩的示例，来看配置：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>&lt;RollingFile name=&quot;RollingFileGZ&quot; fileName=&quot;gz/rolling.log&quot;\n             filePattern=&quot;gz/%d{yyyy-MM-dd-HH}-%i.rolling.gz&quot;&gt;\n    &lt;PatternLayout&gt;\n        &lt;Pattern&gt;%d %p %c{1.} [%t] %m%n&lt;/Pattern&gt;\n    &lt;/PatternLayout&gt;\n    &lt;Policies&gt;\n        &lt;SizeBasedTriggeringPolicy size=&quot;1 KB&quot;/&gt;\n    &lt;/Policies&gt;\n&lt;/RollingFile&gt;\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>fileName 的属性值中包含了一个目录 gz，也就是说日志文件都将放在这个目录下。</p></li><li><p>filePattern 的属性值中增加了一个 gz 的后缀，这就表明日志文件要进行压缩了，还可以是 zip 格式。</p></li></ul><p>运行 Demo 后，可以在 gz 目录下看到以下文件：</p><p><img src="http://cdn.tobebetterjavaer.com/tobebetterjavaer/images/gongju/log4j2-1b04167d-a11f-4447-9062-cb3cdd59aa73.png" alt="" loading="lazy"></p><p>到此为止，Log4j 2 的基本使用示例就已经完成了。测试环境搞定，我去问一下老板，要不要在生产环境下使用 Log4j 2。</p><img src="http://cdn.tobebetterjavaer.com/tobebetterjavaer/images/xingbiaogongzhonghao.png">',80),m={},k=(0,s(13860).Z)(m,[["render",function(n,a){const s=(0,e.up)("ExternalLinkIcon");return(0,e.wg)(),(0,e.iD)("div",null,[t,(0,e._)("p",null,[(0,e._)("a",l,[o,(0,e.Wm)(s)]),i,(0,e._)("a",p,[c,(0,e.Wm)(s)]),g,(0,e._)("a",r,[u,(0,e.Wm)(s)]),d]),v])}]])},13860:(n,a)=>{a.Z=(n,a)=>{const s=n.__vccOpts||n;for(const[n,e]of a)s[n]=e;return s}}}]);